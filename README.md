# Argo CD

This task syncs (deploys) an [Argo CD](https://argoproj.github.io/argo-cd/) application and waits for it to be healthy. To do so, it requires the address of the Argo CD server and some form of authentication - either a username/password or an authentication token.

# Install Argo CD Server


```
kubectl create namespace argocd
kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml
```
This will create a new namespace, argocd, where Argo CD services and application resources will live.
## Download Argo CD CLI
Download the latest Argo CD version from https://github.com/argoproj/argo-cd/releases/latest.

### Also available in Mac Homebrew:

```
brew tap argoproj/tap
brew install argoproj/tap/argocd
```

## Service Type Load Balancer
Change the argocd-server service type to LoadBalancer:

```
kubectl patch svc argocd-server -n argocd -p '{"spec": {"type": "LoadBalancer"}}'
```

After you change Service Type as Load Balancer 

```
kubectl get svc -n argocd
NAME                    TYPE           CLUSTER-IP       EXTERNAL-IP   PORT(S)                      AGE
argocd-server           LoadBalancer   172.30.53.84     <pending>     80:30051/TCP,443:32345/TCP   2h
```

use Node port <32345> to login into argocd server with cluster(kubernets/openshift) ip 

## Login Using The CLI
Login as the admin user. The initial password is autogenerated to be the pod name of the Argo CD API server. This can be retrieved with the command:

```
kubectl get pods -n argocd -l app.kubernetes.io/name=argocd-server -o name | cut -d'/' -f 2
```

Using the above password, login to Argo CD's IP or hostname:

```
argocd login <ARGOCD_SERVER>:<NodePort>
```

Change the password using the command:

```
argocd account update-password
```



### Parameters

* **application-name:** Name of the application to sync

* **revision:** The revision to sync to (_default:_ `HEAD`)

* **flags:** Flags to append after commands, e.g. `--insecure` (_default:_ `--`)

## Usage

This `Pipeline` implements the typical CD flow using GitOps, as explained [here](https://argoproj.github.io/argo-cd/user-guide/ci_automation/). It runs a sample `Task`  that logs into argocd server and deployes Guestbook sample application , after which it we run to  sync an application based on that repository, and wait for its deployment to be successfull


### Need to provide access to image to run with user for openshift
```
oc adm policy add-scc-to-group anyuid system:authenticated
```


#### create Task, pipeline resources into cluster along with secrets and configmaps under namespace argocd-example

```
kubectl create ns argocd-example
```

### start pipeline using tekton client
```
tkn pipeline start <pipeline-name> -n argocd-example

```

A Breif on pipeline we use to build application using argocd 

```YAML
apiVersion: tekton.dev/v1alpha1
kind: Pipeline
metadata:
  name: argocd-pipeline
spec:
  tasks:
    - name: sync-application
      taskRef:
        name: argocd-task-sync-and-wait
      params:
        - name: application-name
          value: some-application
        - name: flags
          value: --insecure # needed in this example only because the Argo CD server is locally hosted
```

For the `Secret`, choose one of username/password or auth token for logging in. Either of the following are acceptable:

```YAML
data:
  ARGOCD_USERNAME: <username>
  ARGOCD_PASSWORD: <password>
```

```YAML
data:
  ARGOCD_AUTH_TOKEN: <token>
```